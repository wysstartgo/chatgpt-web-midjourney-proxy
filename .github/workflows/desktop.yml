name: Release Desktop

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  create-release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.set-out.outputs.release_id }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Read version from package.json
        run: echo "PACKAGE_VERSION=$(node -p \"require('./package.json').version\")" >> $GITHUB_ENV

      # 如果是由发布触发，直接拿当前发布的 release_id
      - name: Use current release id (release event)
        if: github.event_name == 'release'
        run: echo "RID=${{ github.event.release.id }}" >> $GITHUB_ENV

      # 如果是手动触发，则按 v{version} 创建或复用草稿 release
      - name: Create or get release by tag (manual dispatch)
        if: github.event_name != 'release'
        id: create_or_get
        uses: actions/github-script@v6
        env:
          TAG: v${{ env.PACKAGE_VERSION }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const tag   = process.env.TAG;

            // 先尝试按 tag 查
            try {
              const { data } = await github.rest.repos.getReleaseByTag({ owner, repo, tag });
              core.setOutput('rid', data.id.toString());
              return;
            } catch (e) {
              // 不存在就创建一个草稿 release（会同时创建 tag）
              const { data } = await github.rest.repos.createRelease({
                owner, repo,
                tag_name: tag,
                name: tag,
                draft: true,
                prerelease: false
              });
              core.setOutput('rid', data.id.toString());
            }

      - name: Set job output
        id: set-out
        run: |
          echo "release_id=${RID:-${{ steps.create_or_get.outputs.rid }}}" >> $GITHUB_OUTPUT

  build-tauri:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        config:
          - os: macos-latest
            rust_target: x86_64-apple-darwin,aarch64-apple-darwin
            args: --target universal-apple-darwin
          - os: windows-latest
            rust_target: x86_64-pc-windows-msvc
            args: ""
          # 如需 Linux 再加一个 matrix 项

    runs-on: ${{ matrix.config.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm & deps
        run: |
          npm i -g pnpm
          pnpm install

      - name: Install Rust toolchains
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.config.rust_target }}

      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.config.os }}

      # —— 关键：把 base64 的私钥还原为“多行”环境变量，避免注释行丢失 ——
      - name: Restore Tauri updater private key (multiline safe)
        if: ${{ secrets.TAURI_PRIVATE_KEY_B64 != '' }}
        run: |
          echo "$TAURI_PRIVATE_KEY_B64" | base64 --decode > private.key
          {
            echo 'TAURI_PRIVATE_KEY<<EOF'
            cat private.key
            echo 'EOF'
          } >> $GITHUB_ENV
        shell: bash
        env:
          TAURI_PRIVATE_KEY_B64: ${{ secrets.TAURI_PRIVATE_KEY_B64 }}


      - name: Build with tauri-action
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # 用还原后的多行变量；如果你的私钥无口令，就不要提供 TAURI_KEY_PASSWORD
          TAURI_PRIVATE_KEY: ${{ env.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: ${{ matrix.config.args }}

  publish-release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    needs: [create-release, build-tauri]
    steps:
      # 如果是手动触发创建的草稿 release，上传完产物后把草稿改为正式
      - name: Publish release (finalize if draft)
        if: github.event_name != 'release'
        uses: actions/github-script@v6
        env:
          RID: ${{ needs.create-release.outputs.release_id }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const id    = process.env.RID;
            // 读取一次，只有在 draft=true 时才改
            const { data } = await github.rest.repos.getRelease({ owner, repo, release_id: id });
            if (data.draft) {
              await github.rest.repos.updateRelease({ owner, repo, release_id: id, draft: false, prerelease: false });
            }
